<!doctype html>
<script type="text/javascript"> var $SCRIPT_ROOT = {{ request.script_root|tojson|safe }}; </script>
<script type="text/javascript" src="https://code.jquery.com/jquery-3.3.1.min.js"></script>
<script type="text/javascript" src="https://cdn.datatables.net/1.10.19/js/jquery.dataTables.min.js"></script>
<script type="text/javascript" src="https://cdn.datatables.net/plug-ins/1.10.19/pagination/input.js"></script>

<script type="text/javascript" src="https://cdn.datatables.net/buttons/1.5.1/js/dataTables.buttons.min.js"></script>
<script type="text/javascript" src="https://cdn.datatables.net/buttons/1.5.1/js/buttons.flash.min.js"></script>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.1.3/jszip.min.js"></script>
<script type="text/javascript" src="https://cdn.datatables.net/buttons/1.5.1/js/buttons.html5.min.js"></script>


<link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.10.19/css/jquery.dataTables.min.css">
<link rel="stylesheet" type="text/css" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css">


<script type="text/javascript">
    $(function() {
        var refresh_all = function(e) {
            var obj = $(this);
            if (obj.hasClass('btn-primary')) {
                obj.removeClass('btn-primary').addClass('btn-secondary');
                $.getJSON($SCRIPT_ROOT + '/detect_openpr_all', {
                    repo: $('table').attr('id'),
                }, function(data) {
                    obj.removeClass('btn-secondary').addClass('btn-primary');
                    location.reload();
                });
            }
        };
        $('#refresh_all').click(refresh_all);

        var refresh = function(e) {
            var obj = $(this);
            if (obj.hasClass('btn-success')) {
                obj.removeClass('btn-success').addClass('btn-warning');
                $.getJSON($SCRIPT_ROOT + '/detect_openpr', {
                    repo: $('table').attr('id'),
                    num: obj.parent().siblings('.num').text(),
                }, function(data) {
                    obj.removeClass('btn-warning').addClass('btn-success');
                    location.reload();
                });
            }
        };

        $('table button').click(refresh);
    });
</script>

<script>
$(document).ready( function () {
    var t = $('table').DataTable({
        "columnDefs": [ { "searchable": false, "orderable": false, "targets": 0 },
                        { "searchable": false, "orderable": false, "targets": 7 },
                      ],
        dom: 'Blfrtip',
        buttons: [
            'csv',
        ],
        "order": [[ 5, "desc" ]],
        "pagingType": "input",
        fixedColumns:   {
            heightMatch: 'none'
        },
    });
    
    // Build the row number.
    t.on( 'order.dt search.dt', function () {
        t.column(0, {search:'applied', order:'applied'}).nodes().each( function (cell, i) {
            cell.innerHTML = i+1;
        } );
    } ).draw();
} );
</script>


<div>
<h2>
    <b> Duplicate Detection </b> of Open Pull Requests of <i> {{ repo }} </i> DashBoard 
    <button type="button" class="btn btn-primary btn-sm">
            <a href="{{ url_for('openpr') }}" style="color:inherit">Homepage</a>
        </button>
    <button type="button" class="btn btn-primary btn-sm" id="refresh_all">
        Refresh All
    </button>
</h2>
</div>

<table id="{{ repo }}" class="display">
    <thead>
        <tr>
            <th> </th>
            <th> Number </th>
            <th> Title </th>
            <th> Dup's Number </th>
            <th> Dup's Title </th>
            <th> Level </th>
            <th> Proba </th>
            <th> </th>
        </tr>
    </thead>
    <tbody>
        {% for pull in pr_list %}
        <tr>
            <td> </td>
            
            <td class="num"> {{ pull.get('num', '') }} </td>

            <td>
                {% if 'state' in pull %}
                {{ '[%s]' % pull.get('state').upper() }}
                {% endif %}
                <a tag="title" href="{{ pull.get('link', '') }}" target="_blank">{{ pull.get('title', '') }} </a>
            </td>

            <td class="num2"> {{ pull.get('num2', '') }} </td>

            <td>
                {% if 'state2' in pull %}
                {{ '[%s]' % pull.get('state2').upper() }}
                {% endif %}
                <a tag="title2" href="{{ pull.get('link2', '') }}" target="_blank"> {{ pull.get('title2', '') }} </a>
            </td>

            <td class="level">
                {{ "Probably" if pull.get('proba', -1) >= 0.99 else ("Maybe" if pull.get('proba', -1) >= 0.90 else '') }}
            </td>

            <td class="proba">
                {% if 'proba' in pull %}
                {{ '%04f' % pull.get('proba') }}
                {% endif %}
            </td>
    
            <td>
                <button type="button" class="btn btn-success btn-sm" id="refresh">Refresh</button>
            </td>
        </tr>
        {% endfor %}
    </tbody>
</table>



